---
title: "Workshop 3 [Week 6] linear regression"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

Notebook code chunks can be inserted quickly using the keyboard shortcut Ctrl + Alt + I (macOS: Cmd + Option + I ), or via the Insert menu in the editor toolbar.


When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

# **************************************
# PART FOUR: CLASS EXERCISES           *
# **************************************
# Jon Sadler -  Mar 10th 2022

Load libraries - you might need to install them.
```{r}
library(tidyverse)
library(ggfortify)
library(car)
library(MuMIn)
```

#1. Linear Regression using the faithful dataset
# look at the data in the base file
```{r}
str(faithful)
```

# plot some pictures
```{r}
scatterplot(eruptions ~ waiting, data = faithful)	
```

# Looks decent in terms of the boxplots - indicates normality and homogeneity of variance
# Maybe an issue with linearity of the response to explanatory but we'll have a look
# Using ggplot
What's missing in this code?
```{r}
ggplot(faithful,aes(waiting,eruptions)) + geom_point() + geom_smooth(method=lm) 
```

# Specify and examine linear model
```{r}
summary(lm(eruptions ~ waiting, data = faithful))
anova(lm(eruptions ~ waiting, data = faithful))
```

# write the model to an object
```{r}
faithful.lm <- lm(eruptions ~ waiting, data = faithful)
```

# look at plots for validation
```{r}
par(mfrow = c(2, 2)) 
plot(faithful.lm)
```
# QQ-plot indicates normality
# residuals v fitted suggests limited heterogeneity that is a result of two clumps of points, but it the residuals are evenly spread either side of the zero line.
# Scale v location indicates homogeneity
# Leverage plot is fine - no serious points with excessive leverage

# same plots in ggfortify
```{r}
autoplot(faithful.lm) 
```
# plot residuals against explanatory
```{r}
plot(faithful.lm$resid ~ faithful$waiting,
     xlab = "Waiting time (mins)",
     ylab = "Model residuals")
```
Generally fine so we'll go with it for the time being. 

# Decision will run with a linear model
We could run an non-linear model on this one (i.e. a Generalised Additive Model), but this isn't really necessary.
# plot model and add R-square etc. Notice we need all the code in the code window, we cannot pass between code chunks unless write to an object 

```{r}
plot(eruptions ~ waiting, data = faithful,
     xlab = "Waiting time between eruptions (mins)",
     ylab = "Eruption duration (mins)",
     pch = 21, col = "grey", bg = "grey") # We've left the axes on
# add the regression line from the model (faithful.lm) using abline.....
abline(faithful.lm, col="black")
# add the equation
text(99,2, "eruptions = 0.0756waiting + -1.874", pos = 2, cex=0.8)
# add r-square value
text(99,1.75, expression(paste(R^2 == 0.8108)), pos = 2, cex = 0.8) # add in text using the expression/paste functions
#for each value of x, calculate the upper and lower 95% confidence
x <- seq(min(faithful$waiting), max(faithful$waiting), l=1000)  # notice this is an 'l' = length. NOT a 1!!!!!!!
#for each value of x, calculate the upper and lower 95% confidence
y<-predict(faithful.lm, data.frame(waiting=x), interval="c")
#plot the upper and lower 95% confidence limits
matlines(x,y, lty=3, col="black") # This function add the CIs, lty = line type (dashed)
```

# create a sequence of 1000 number spanning the range of humidities (min to max)

Set up the plot and copy it into an object called p
```{r}
p <- ggplot(faithful, aes(x=waiting, y=eruptions)) + 
  geom_point(col = "grey") +
  geom_smooth(method=lm, col = "black") + 
  annotate(geom = "text", x = 50, y = 6,
           label = "Eruptions = -0.076Waiting + -1.87\nAdj. R2 = 0.8108",
           hjust = 0)
```

Create the plot....
```{r}
p + xlab("Waiting time between eruptions (mins)") + ylab("Eruption duration (mins)") + theme_bw()
```
# Predict and plot with ggplot
# add 'fit', 'lwr', and 'upr' columns to dataframe (generated by predict)
```{r}
old.predict <- cbind(faithful, predict(faithful.lm, interval = 'confidence'))
```

# plot the points (actual observations), regression line, and confidence interval
```{r}
p <- ggplot(old.predict, aes(waiting,eruptions))
p <- p + geom_point()
p <- p + geom_line(aes(waiting, fit))
p <- p + geom_ribbon(aes(ymin=lwr,ymax=upr), alpha=0.3)
p
```

# 2. Mussel dataset using abundance as a response variable
# load data file
```{r}
Mussel <- read.csv("Mussel.csv")
```

# Look at it
```{r}
glimpse(Mussel)
```
```{r}
scatterplot(INDIV ~ AREA, data = Mussel)
```
# This indicates that the data are not normaly disributed (especially AREA)
# The abundance data don't look too good either. Huge peak in the middle
# outliers in both!!!!

# Let's fit a linear model nonetheless and look at it
```{r}
mussel.lm <- lm(INDIV ~ AREA, data = Mussel)
summary(mussel.lm)
```

# Area looks to significantly related to the number of mussels
# Now check assumption by using R's inbuilt model validation plot defaults

```{r}
autoplot(mussel.lm)
```
# Residuals v Fitted indicate a problem. It's wedge shaped and humped!
# qqplot is a bit dodgy but might be okay
# Scale-Location plot indicates a wedge
# Cook distance / leverage looks okay - but there are some large values in area

# FINAL VALIDATION TASK - residuals against explanatory variable
```{r}
plot(mussel.lm$resid ~ Mussel$AREA,
     xlab = "Mussel bed Area", 
     ylab = "Residuals")
```
# Some code for ggplot to do the same thing.....
```{r}
ggplot(fortify(mussel.lm, Mussel), aes(AREA, .stdresid)) +
  geom_point() + geom_smooth(se = TRUE)
```
# This indicates a few large values and a slight wedge due to numerous small patches
# Conclusion we reject the model

# So what do we do?
# We can linearise the explanatory variables by transforming them and re-run the model
# I am not a fan of this - we'll look at other approaches in the coming weeks!
# and repeat the validation

# Let's fit a linear model nonetheless and look at it
```{r}
mussel.lm1 <- lm(I ~ log10(AREA), data = Mussel)
summary(mussel.lm1)
```

# Now check assumption by using R's inbuilt model validation plot defaults
# set graphics parameters because we want all the plots on one graphic
```{r}
autoplot(mussel.lm1)
```
# Residuals v Fitted are better but there is still a bit of wedge at higher fitted values
# qqplot is a better
# Scale-Location plot indicates a slight wedge with higher values
# Cook distance / leverage looks improved

# FINAL VALIDATION TASK - residuals against explanatory variable
```{r}
ggplot(fortify(mussel.lm1, Mussel), aes(AREA, .stdresid)) +
  geom_point() + geom_smooth(se = FALSE)
```
# This indicates a few large values and a slight wedge due to numerous small patches
# Conclusion we reject the model

# Try log10 on the response - not unusual with abundance data.
# There are no zeros so we don't need an offset of 0.01 or something similar
# fit a linear model - there are other ways of dealing with this. We'll get to them later in the series of workshops

```{r}
mussel.lm2 <- lm(log10(INDIV) ~ log10(AREA), data = Mussel)
summary(mussel.lm2)
```
# Now check assumption 
```{r}
autoplot(mussel.lm2)
```
# Residuals v Fitted are much better 
# qqplot is okay - slight issue on lower values
# Scale-Location plot is fine
# Cook distance / leverage looks okay

# FINAL VALIDATION TASK - residuals against explanatory variable
```{r}
ggplot(fortify(mussel.lm2, Mussel), aes(log10(AREA), .stdresid)) +
  geom_point() 
```

# This is better but still a slight hump
# Conclusion we accept the model

# plot the final model in ggplot...
```{r}
library(scales) # You need this library to to access break formatting functions for log axes
p <- ggplot(Mussel, aes(AREA,INDIV)) + 
  geom_point(col = "grey") +
  geom_smooth(method=lm, col = "black") + 
  annotate(geom = "text", x = 1000, y = 30,
           label = "log10(INDIV) = 0.835 + log10(AREA) - 0.576\n[Adj. R2 = 0.8108]", hjust = 0)  # adds text (NOTE \n means start new line)
p + scale_x_continuous(trans = 'log10') + scale_y_continuous(trans = 'log10') + # These commands scale the axes
  annotation_logticks(sides="lb") # This adds log10 tick marks
```
#Plot the graph add equations in base R without log tick marks
```{r}
plot(log10(INDIV) ~ log10(AREA), data = Mussel,
     xlab = "Log Mussel clump area (mm2)",
     ylab = "Log Number of Individuals",
     pch = 21, col = "grey", bg = "grey") # We've left the axes on
# add the regression line from the model (faithful.lm) using abline.....
abline(mussel.lm2, col="black")
# add the equation
text(4.0, 1.4, expression(paste(Log[10], "INDIV = 0.835", log[10], "AREA - 0.576", pos = 2)), cex = .7)
# add r-square value
text(4.0, 1.3, expression(paste(R^2 == 0.852)), cex = .7) # add in text using the expression/paste functions
# create a sequence of 1000 number spanning the range of humidities (min to max)
x <- seq(min(Mussel$AREA), max(Mussel$AREA), l=1000)  # notice this is an 'l' = length. NOT a 1!!!!!!!
#for each value of x, calculate the upper and lower 95% confidence
y<-predict(mussel.lm2, data.frame(AREA=x), interval="c")
#plot the upper and lower 95% confidence limits
matlines(log10(x),y, lty=3, col="black") # This function add the CIs, lty = line type (dashed) 

```


# add in ggplot code....
```{r}
p <- ggplot(Mussel, aes(x=log10(AREA), y=log10(INDIV))) + 
  geom_point(col = "blue") +
  geom_smooth(method=lm, col = "black") + 
  annotate(geom = "text", x = 2.5, y = 3,
           label = "Log10INDIV = 0.835 + log10AREA - 0.576\nAdj. R2 = 0.852",
           hjust = 0)
p + xlab("Log Mussel clump area (mm2)") + ylab("Log number of individuals")

```

